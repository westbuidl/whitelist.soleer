"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.initBackgroundInBrowser = void 0;
const tslib_1 = require("tslib");
const background_1 = require("./background");
const defaultSessionsBackgroundUrl = window.location.origin +
    `${process.env.ASSET_PREFIX || ''}/workers/sessions-background-sharedworker.js`
        .replace(/\/+/g, '/');
const initBackgroundInBrowser = (...args_1) => tslib_1.__awaiter(void 0, [...args_1], void 0, function* (sessionsBackgroundUrl = defaultSessionsBackgroundUrl) {
    try {
        yield fetch(sessionsBackgroundUrl, { method: 'HEAD' }).then(response => {
            if (!response.ok) {
                throw new Error(`Failed to fetch sessions-background SharedWorker from url: ${sessionsBackgroundUrl}`);
            }
        });
        const background = new SharedWorker(sessionsBackgroundUrl, {
            name: '@trezor/connect-web transport sessions worker',
        });
        const requestFn = (params) => new Promise(resolve => {
            const onmessage = (message) => {
                if (params.id === message.data.id) {
                    resolve(message.data);
                    background.port.removeEventListener('message', onmessage);
                }
            };
            background.port.addEventListener('message', onmessage);
            background.port.onmessageerror = message => {
                console.error('background-browser onmessageerror,', message);
                background.port.removeEventListener('message', onmessage);
            };
            background.port.postMessage(params);
        });
        const registerBackgroundCallbacks = onDescriptorsCallback => {
            background.port.addEventListener('message', (e) => {
                if ('type' in (e === null || e === void 0 ? void 0 : e.data)) {
                    if (e.data.type === 'descriptors') {
                        onDescriptorsCallback(e.data.payload);
                    }
                }
            });
        };
        return { background, requestFn, registerBackgroundCallbacks };
    }
    catch (err) {
        console.warn('Unable to load background-sharedworker. Falling back to use local module. Say bye bye to tabs synchronization. Error details: ', err.message);
        const background = new background_1.SessionsBackground();
        const registerBackgroundCallbacks = onDescriptorsCallback => {
            background.on('descriptors', descriptors => {
                onDescriptorsCallback(descriptors);
            });
        };
        return {
            background,
            requestFn: background.handleMessage.bind(background),
            registerBackgroundCallbacks,
        };
    }
});
exports.initBackgroundInBrowser = initBackgroundInBrowser;
//# sourceMappingURL=background-browser.js.map